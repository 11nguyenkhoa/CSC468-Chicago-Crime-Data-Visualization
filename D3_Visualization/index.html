<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
  <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
  <script src="https://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>

  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />

  <script src="bound.js"></script>
  <style src="style.css"></style>

  <style>
    body {
      margin: 0;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }

    #map {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    svg {
      position: absolute;
      width: 100%;
      height: 100%;
    }

        .map-overlay {
      font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
      position: absolute;
      width: 400px;
      top: 0;
      left: 0;
      padding: 10px;
    }
  
    .map-overlay .map-overlay-inner {
      background-color: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      border-radius: 3px;
      padding: 10px;
      margin-bottom: 10px;
    }
  
    .map-overlay h2 {
      line-height: 24px;
      display: block;
      margin: 0 0 10px;
    }
  
    .map-overlay .legend .bar {
      height: 10px;
      width: 100%;
      background: linear-gradient(to right, #fca107, #7f3121);
    }
  
    .map-overlay input {
      background-color: transparent;
      display: inline-block;
      width: 100%;
      position: relative;
      margin: 0;
      cursor: ew-resize;
    }

  </style>
</head>

<body>
  <div id="map"></div>

  <div class="map-overlay top">
    <div class="map-overlay-inner">
      <h2>Chicago Crimes in 2020</h2>
      <div id="legend" class="legend">
        <div class="bar"></div>
        <div>Density</div>
      </div>
      <p>
        <label for="amount">Date range:</label>
        <input type="text" id="amount" style="border: 0; color: #f6931f; font-weight: bold;" size="100" />
      </p>
      <div id="slider-range"></div>
    </div>    
  </div>

  <script>
    var url = "Crime_2020_points.geojson"

    //Mapbox crime date filter
      function filterBy(startMonth, endMonth) {
        var filters = ['all', ['>=', 'month', startMonth], ['<=', 'month', endMonth]];
        map.setFilter('crimes-point', filters);
        map.setFilter('crimes-heat', filters);
        map.setFilter('crime-category-labels', filters);

        // Set the label to the month
        //document.getElementById('month').textContent = months[month];
      }
      
    mapboxgl.accessToken = 'pk.eyJ1IjoiZW5qYWxvdCIsImEiOiJjaWhtdmxhNTIwb25zdHBsejk0NGdhODJhIn0.2-F2hS_oTZenAWc0BMf_uw'
      //Setup mapbox-gl map
      var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/dark-v10',
        center: [-87.635, 41.9199],
        zoom: 10.00,

      });
    
      map.on('load', function () {
        d3.json(url, function (err, data) {
          // Create a month property value based on time
          // used to filter against.
          data.features = data.features.map(function (d) {
            d.properties.month = new Date(d.properties.date).getMonth();
            return d;
          });

          console.log(data)

          map.addSource('crimes', {
            type: 'geojson',
            data: data
          });
          // add heatmap layer here
          map.addLayer({
            id: 'crimes-heat',
            type: 'heatmap',
            source: 'crimes',

            paint: {
              // increase weight as diameter breast height increases
              'heatmap-weight': {
                property: 'dbh',
                type: 'exponential',
                stops: [
                  [1, 0],
                  [62, 1]
                ]
              },
              // increase intensity as zoom level increases
              'heatmap-intensity': {
                stops: [
                  [11, 1],
                  [15, 3]
                ]
              },
              // assign color values be applied to points depending on their density
              'heatmap-color': [
                'interpolate',
                ['linear'],
                ['heatmap-density'],
                0,
                'rgba(33,102,172,0)',
                0.2,
                'rgb(103,169,207)',
                0.4,
                'rgb(209,229,240)',
                0.6,
                'rgb(253,219,199)',
                0.8,
                'rgb(239,138,98)',
                1,
                'rgb(178,24,43)'
              ],
              // increase radius as zoom increases
              'heatmap-radius': {
                stops: [
                  [11, 15],
                  [15, 20]
                ]
              },
              // decrease opacity to transition into the circle layer
              'heatmap-opacity': {
                default: 1,
                stops: [
                  [14, 1],
                  [15, 0]
                ]
              },
            }
          }, 'waterway-label');
          // add circle layer here
          map.addLayer({
            id: 'crimes-point',
            type: 'circle',
            source: 'crimes',
            minzoom: 14,
            paint: {
              // increase the radius of the circle as the zoom level and dbh value increases
              'circle-radius': {
                property: 'dbh',
                type: 'exponential',
                stops: [
                  [{ zoom: 15, value: 1 }, 5],
                  [{ zoom: 15, value: 62 }, 10],
                  [{ zoom: 22, value: 1 }, 20],
                  [{ zoom: 22, value: 62 }, 50],
                ]
              },
              'circle-color': [
                'match',
                ['get', 'primary_type'],
                'THEFT',
                '#fbb03b',
                'BATTERY',
                '#223b53',
                'CRIMINAL DAMAGE',
                '#e55e5e',
                'ASSAULT',
                '#3bb2d0',
                /* other */ '#ccc'
              ]
              ,
              'circle-stroke-color': 'white',
              'circle-stroke-width': 1,
              'circle-opacity': {
                stops: [
                  [14, 0],
                  [15, 1]
                ]
              }
            }
          }, 'waterway-label');

          map.addLayer({
            'id': 'crime-category-labels',
            'type': 'symbol',
            'source': 'crimes',
            'layout': {
              'text-field': ['get', 'primary_type'],
              'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
              'text-radial-offset': 0.5,
              'text-justify': 'auto',
              'text-size': 12
            },
            'paint': {
              "text-color": "#ffffff"
            }
          });

          // Set filter to first month of the year
          // 0 = January
          filterBy(0, 1);

          //jQuery script for dual bar slider
          $(function () {
            $("#slider-range").slider({
              range: true,
              min: new Date('2020.01.01').getTime() / 1000,
              max: new Date('2020.06.01').getTime() / 1000,
              step: 6,
              values: [new Date('2020.01.01').getTime() / 1000, new Date('2020.02.01').getTime() / 1000],
              slide: function (event, ui) {
                //console.log(ui.values.map((date) => { return new Date(date * 1000).getMonth()}))
                let dateRange = ui.values.map((date) => { return new Date(date * 1000).getMonth() })
                filterBy(dateRange[0], dateRange[1])
                $("#amount").val((new Date(ui.values[0] * 1000).toDateString()) + " - " + (new Date(ui.values[1] * 1000)).toDateString());
              }
            });

            $("#amount").val((new Date($("#slider-range").slider("values", 0) * 1000).toDateString()) +
              " - " + (new Date($("#slider-range").slider("values", 1) * 1000)).toDateString());
          });

        });
      });


    

    
    //map.scrollZoom.disable()
    //map.addControl(new mapboxgl.Navigation());
    map.addControl(new mapboxgl.NavigationControl());
    map.dragRotate.disable();
    map.doubleClickZoom.disable();

    runD3()

  </script>
</body>